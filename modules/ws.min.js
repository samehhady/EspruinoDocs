function strChr(t){return String.fromCharCode(t)}function hexEncode(t){for(var e=[],o=0;o<t.length;o+=2)e.push(String.fromCharCode("0x"+t.substr(o,2)));return btoa(e.join(""))}function sha1(){var t,e,o,r,n,i,s,c,h,a=function(t,e){var o=t<<e|t>>>32-e;return o},p=function(t){var e,o,r="";for(e=7;e>=0;e--)o=t>>>4*e&15,r+=o.toString(16);return r},f=new Array(80),d=1732584193,u=4023233417,k=2562383102,S=271733878,b=3285377520;str=unescape(encodeURIComponent(str));var v=str.length,l=[];for(e=0;v-3>e;e+=4)o=str.charCodeAt(e)<<24|str.charCodeAt(e+1)<<16|str.charCodeAt(e+2)<<8|str.charCodeAt(e+3),l.push(o);switch(v%4){case 0:e=2147483648;break;case 1:e=str.charCodeAt(v-1)<<24|8388608;break;case 2:e=str.charCodeAt(v-2)<<24|str.charCodeAt(v-1)<<16|32768;break;case 3:e=str.charCodeAt(v-3)<<24|str.charCodeAt(v-2)<<16|str.charCodeAt(v-1)<<8|128}for(l.push(e);l.length%16!=14;)l.push(0);for(l.push(v>>>29),l.push(v<<3&4294967295),t=0;t<l.length;t+=16){for(e=0;16>e;e++)f[e]=l[t+e];for(e=16;79>=e;e++)f[e]=a(f[e-3]^f[e-8]^f[e-14]^f[e-16],1);for(r=d,n=u,i=k,s=S,c=b,e=0;19>=e;e++)h=a(r,5)+(n&i|~n&s)+c+f[e]+1518500249&4294967295,c=s,s=i,i=a(n,30),n=r,r=h;for(e=20;39>=e;e++)h=a(r,5)+(n^i^s)+c+f[e]+1859775393&4294967295,c=s,s=i,i=a(n,30),n=r,r=h;for(e=40;59>=e;e++)h=a(r,5)+(n&i|n&s|i&s)+c+f[e]+2400959708&4294967295,c=s,s=i,i=a(n,30),n=r,r=h;for(e=60;79>=e;e++)h=a(r,5)+(n^i^s)+c+f[e]+3395469782&4294967295,c=s,s=i,i=a(n,30),n=r,r=h;d=d+r&4294967295,u=u+n&4294967295,k=k+i&4294967295,S=S+s&4294967295,b=b+c&4294967295}return h=p(d)+p(u)+p(k)+p(S)+p(b),h.toLowerCase()}function WebSocket(t,e){this.socket=null,e=e||{},this.host=t,this.port=e.port||80,this.protocolVersion=e.protocolVersion||13,this.origin=e.origin||"Espruino",this.keepAlive=1e3*e.keepAlive||6e4}function WebSocketServer(t){this.socket=null,t=t||{},this.port=t.port||80}WebSocket.prototype.initClient=function(){require("net").connect({host:this.host,port:this.port},this.onConnect.bind(this))},WebSocket.prototype.initServer=function(){require("net").createServer(this.onServer.bind(this)).listen(this.port)},WebSocket.prototype.onServer=function(t){this.socket=t;var e=this;t.on("data",this.handleData.bind(this)),t.on("close",function(){e.emit("close")})},WebSocket.prototype.onConnect=function(t){this.socket=t;var e=this;t.on("data",this.parseData.bind(this)),t.on("close",function(){e.emit("close")}),this.emit("open"),this.handshake()},WebSocket.prototype.parseData=function(t){var e=this;if(this.emit("rawData",t),t.indexOf("HSmrc0sMlYUkAGmm5OPpG2HaGWk=")>-1){this.emit("handshake");{setInterval(function(){e.send("ping",137)},this.keepAlive)}}if(t.indexOf(strChr(138))>-1&&this.emit("pong"),t.indexOf(strChr(137))>-1&&(this.send("pong",138),this.emit("ping")),t.indexOf(strChr(10))>-1&&(t=t.substring(1)),t.indexOf(strChr(129))>-1){var o=t.charCodeAt(1);t=t.substring(2);for(var r="",n=0;o>n;n++)r+=t[n];this.emit("message",r)}},WebSocket.prototype.handshake=function(){for(var t=["GET / HTTP/1.1","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==","Sec-WebSocket-Version: "+this.protocolVersion,"Origin: "+this.origin,""],e=0;e<t.length;e++)this.socket.write(t[e]+"\r\n")},WebSocketServer.prototype.handleData=function(t){var e=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=",""];if(t.indexOf("Sec-WebSocket-Key")>-1){for(var o=0;o<e.length;o++)this.socket.write(e[o]+"\r\n");this.emit("connection",this)}},WebSocket.prototype.send=function(t,e){e=void 0===e?129:e,JSON.parse(t)||(t='{"msg":"'+t+'"}'),this.socket.write(strChr(e)),this.socket.write(strChr(t.length)),this.socket.write(t)},WebSocket.prototype.broadcast=function(t,e){e=void 0===e?"all":e;var o='{"room":"'+e+'", "msg":"'+t+'"}';this.send(o)},WebSocket.prototype.join=function(t){var e='{"join":"'+t+'"}';this.send(e)},exports=function(t,e){var o=new WebSocket(t,e);return o.initClient(),o},exports.Server=function(t){var e=new WebSocketServer(t);return e.initServer(),e};
