function strChr(t){return String.fromCharCode(t)}function hexEncode(t){for(var e=[],r=0;r<t.length;r+=2)e.push(String.fromCharCode("0x"+t.substr(r,2)));return btoa(e.join(""))}function sha1(){var t,e,r,o,i,n,s,c,h,a=function(t,e){var r=t<<e|t>>>32-e;return r},p=function(t){var e,r,o="";for(e=7;e>=0;e--)r=t>>>4*e&15,o+=r.toString(16);return o},f=new Array(80),u=1732584193,d=4023233417,k=2562383102,S=271733878,l=3285377520;str=unescape(encodeURIComponent(str));var b=str.length,v=[];for(e=0;b-3>e;e+=4)r=str.charCodeAt(e)<<24|str.charCodeAt(e+1)<<16|str.charCodeAt(e+2)<<8|str.charCodeAt(e+3),v.push(r);switch(b%4){case 0:e=2147483648;break;case 1:e=str.charCodeAt(b-1)<<24|8388608;break;case 2:e=str.charCodeAt(b-2)<<24|str.charCodeAt(b-1)<<16|32768;break;case 3:e=str.charCodeAt(b-3)<<24|str.charCodeAt(b-2)<<16|str.charCodeAt(b-1)<<8|128}for(v.push(e);v.length%16!=14;)v.push(0);for(v.push(b>>>29),v.push(b<<3&4294967295),t=0;t<v.length;t+=16){for(e=0;16>e;e++)f[e]=v[t+e];for(e=16;79>=e;e++)f[e]=a(f[e-3]^f[e-8]^f[e-14]^f[e-16],1);for(o=u,i=d,n=k,s=S,c=l,e=0;19>=e;e++)h=a(o,5)+(i&n|~i&s)+c+f[e]+1518500249&4294967295,c=s,s=n,n=a(i,30),i=o,o=h;for(e=20;39>=e;e++)h=a(o,5)+(i^n^s)+c+f[e]+1859775393&4294967295,c=s,s=n,n=a(i,30),i=o,o=h;for(e=40;59>=e;e++)h=a(o,5)+(i&n|i&s|n&s)+c+f[e]+2400959708&4294967295,c=s,s=n,n=a(i,30),i=o,o=h;for(e=60;79>=e;e++)h=a(o,5)+(i^n^s)+c+f[e]+3395469782&4294967295,c=s,s=n,n=a(i,30),i=o,o=h;u=u+o&4294967295,d=d+i&4294967295,k=k+n&4294967295,S=S+s&4294967295,l=l+c&4294967295}return h=p(u)+p(d)+p(k)+p(S)+p(l),h.toLowerCase()}function WebSocket(t,e){this.socket=null,e=e||{},this.host=t,this.port=e.port||80,this.protocolVersion=e.protocolVersion||13,this.origin=e.origin||"Espruino",this.keepAlive=1e3*e.keepAlive||6e4}function WebSocketServer(t){this.socket=null,t=t||{},this.port=t.port||80;require("sha1")}WebSocket.prototype.initializeClient=function(){require("net").connect({host:this.host,port:this.port},this.onConnect.bind(this))},WebSocket.prototype.initializeServer=function(){require("net").createServer(this.onServer.bind(this)).listen(this.port)},WebSocket.prototype.onServer=function(t){this.socket=t;var e=this;t.on("data",this.handleData.bind(this)),t.on("close",function(){e.emit("close")})},WebSocket.prototype.onConnect=function(t){this.socket=t;var e=this;t.on("data",this.parseData.bind(this)),t.on("close",function(){e.emit("close")}),this.emit("open"),this.handshake()},WebSocket.prototype.parseData=function(t){var e=this;if(this.emit("rawData",t),t.indexOf("HSmrc0sMlYUkAGmm5OPpG2HaGWk=")>-1){this.emit("handshake");{setInterval(function(){e.send("ping",137)},this.keepAlive)}}if(t.indexOf(strChr(138))>-1&&this.emit("pong"),t.indexOf(strChr(137))>-1&&(this.send("pong",138),this.emit("ping")),t.indexOf(strChr(10))>-1&&(t=t.substring(1)),t.indexOf(strChr(129))>-1){var r=t.charCodeAt(1);t=t.substring(2);for(var o="",i=0;r>i;i++)o+=t[i];this.emit("message",o)}},WebSocket.prototype.handshake=function(){for(var t=["GET / HTTP/1.1","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==","Sec-WebSocket-Version: "+this.protocolVersion,"Origin: "+this.origin,""],e=0;e<t.length;e++)this.socket.write(t[e]+"\r\n")},WebSocketServer.prototype.handleData=function(t){var e=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=",""];if(t.indexOf("Sec-WebSocket-Key")>-1){for(var r=0;r<e.length;r++)this.socket.write(e[r]+"\r\n");this.emit("connection",this)}},WebSocket.prototype.send=function(t,e){e=void 0===e?129:e,JSON.parse(t)||(t='{"msg":"'+t+'"}'),this.socket.write(strChr(e)),this.socket.write(strChr(t.length)),this.socket.write(t)},WebSocket.prototype.broadcast=function(t,e){e=void 0===e?"all":e;var r='{"room":"'+e+'", "msg":"'+t+'"}';this.send(r)},WebSocket.prototype.join=function(t){var e='{"join":"'+t+'"}';this.send(e)},exports=function(t,e){var r=new WebSocket(t,e);return r.initializeClient(),r},exports.Server=function(t,e){var r=new WebSocketServer(e);return r.initializeServer(),r};
